<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texnikum O'qituvchilar Reytingi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        /* Status Badge uchun ranglar */
        .bg-excellent { background-color: #10b981; } /* Yashil */
        .bg-good { background-color: #f59e0b; } /* Sariq/To'q sariq */
        .bg-poor { background-color: #ef4444; } /* Qizil */

        /* Yangi: Kattalashuvchi Kartochka uchun CSS */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            transition: all 0.5s ease-in-out;
        }

        .teacher-card {
            transition: all 0.5s ease-in-out;
            cursor: pointer;
            z-index: 10;
        }

        /* Kartochka Kattalashganda */
        .teacher-card.expanded {
            grid-column: 1 / -1; /* To'liq kenglikni egallash */
            position: relative;
            z-index: 50; /* Eng ustda turishi */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); /* Kattaroq soya */
            max-height: none !important; 
        }

        /* YASHIRIN KONKENT: Kattalashganida ko'rsatiladi */
        .details-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }

        .teacher-card.expanded .details-content {
            max-height: 2000px; /* Kattalashganda ko'rsatish */
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-white shadow-lg sticky top-0 z-20">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-indigo-800 tracking-wider">üåü O'qituvchilar Reytingi</h1>
            <nav class="flex space-x-4 items-center">
                <a href="charts.html" class="text-sm font-semibold text-purple-700 hover:text-purple-900 px-4 py-2 rounded-full transition duration-200 bg-purple-100 hover:bg-purple-200 shadow-sm">üìä Global Diagramma</a>
                <a href="admin.html" class="text-sm font-semibold text-gray-600 hover:text-gray-800 px-4 py-2 rounded-full transition duration-200 border border-gray-300">Admin Panel</a>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-8 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            
            <h2 class="text-3xl font-extrabold text-gray-900 mb-10 text-center">‚≠ê Umumiy Reyting Jadvallari (100% foizda)</h2>

            <div id="loader" class="text-center py-20">
                <p class="text-2xl font-medium text-indigo-500 animate-pulse">Ma'lumotlar yuklanmoqda...</p>
            </div>

            <div id="teachers-list" class="grid-container">
                </div>
        </div>
    </main>

    <script>
        // *** FIREBASE KONFIGURATSIYASI ***
        const firebaseConfig = {
            apiKey: "AIzaSyBoeZhwbVlnO7ua92G1MEbkgvR56wafczo", 
            authDomain: "myrating-db64e.firebaseapp.com",
            projectId: "myrating-db64e",
            storageBucket: "myrating-db64e.appspot.com",
            messagingSenderId: "544027915154",
            appId: "1:544027915154:web:9ea438a621ea6f0832074b"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const teachersRef = db.collection('teachers');

        const MAX_SCORE = 798;
        
        /**
         * Umumiy ball (foizda) asosida status va rangni aniqlaydi (56-85% oraliq)
         */
        function getScoreStatus(totalScore) {
            const percentage = (totalScore / MAX_SCORE) * 100; 

            let status;
            let chartColor;
            let statusColorClass;

            if (percentage >= 86) {
                status = "A'lo";
                chartColor = '#10b981'; // Yashil
                statusColorClass = 'bg-excellent';
            } else if (percentage >= 56) {
                status = 'Yaxshi';
                chartColor = '#f59e0b'; // Sariq/To'q sariq
                statusColorClass = 'bg-good';
            } else {
                status = 'Qoniqarsiz';
                chartColor = '#ef4444'; // Qizil
                statusColorClass = 'bg-poor';
            }

            return { status, chartColor, percentage, statusColorClass };
        }
        
        // üî• YANGI FUNKSIYA: Kartochkani kattalashtirish
        window.toggleDetails = function(cardElement, teacherData) {
            const isExpanded = cardElement.classList.contains('expanded');
            
            // Avval barcha ochilgan kartochkalarni yopamiz
            document.querySelectorAll('.teacher-card.expanded').forEach(card => {
                card.classList.remove('expanded');
                // Yopilayotgan kartochkaning ichidagi dinamik kontentni o'chiramiz
                const detailDiv = card.querySelector('.details-content');
                if (detailDiv) {
                    detailDiv.innerHTML = '';
                }
            });

            // Agar u yopiq bo'lsa, uni ochamiz
            if (!isExpanded) {
                cardElement.classList.add('expanded');
                // Faqat ochilayotgan kartochkaga tafsilotlarni yuklaymiz
                loadDetails(cardElement, teacherData);
            }
        };

        // üî• YANGI FUNKSIYA: Tafsilotlarni kartochka ichiga yuklash
        function loadDetails(cardElement, teacherData) {
            const detailDiv = cardElement.querySelector('.details-content');
            if (!detailDiv) return;

            // 1. Kriteriyalar bo'yicha ballar ro'yxatini yaratish
            let scoresListHTML = `
                <div class="space-y-2 mt-4 pt-4 border-t border-gray-200">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">Kriteriyalar bo'yicha to'plangan ballar: <span class="text-sm font-normal text-gray-500">(${MAX_SCORE} ball)</span></h4>
                    <ul class="list-none space-y-2">
            `;
            
            const criteria = teacherData.scoreCriteria || {};
            const scoreData = teacherData.scores || {};
            
            Object.keys(criteria).forEach(key => {
                const maxScore = criteria[key];
                const currentScore = scoreData[key] || 0;
                
                const percentage = (currentScore / maxScore) * 100;
                const bgColor = percentage >= 85 ? 'bg-green-100' : percentage >= 55 ? 'bg-yellow-100' : 'bg-red-100';

                scoresListHTML += `
                    <li class="flex justify-between items-center text-sm font-medium py-3 px-4 rounded-xl ${bgColor} border-l-4 border-gray-300 shadow-sm">
                        <span class="text-gray-800 font-semibold">${key}</span>
                        <div class="flex items-center space-x-2">
                            <span class="text-xl font-bold text-gray-900">${currentScore}</span>
                            <span class="text-base text-gray-600"> / ${maxScore} ball</span>
                        </div>
                    </li>
                `;
            });

            scoresListHTML += `</ul></div>`;
            
            // 2. Jarima ballarini qo'shish
            let penaltyHTML = '';
            if (teacherData.penaltyAmount > 0) {
                penaltyHTML = `
                    <div class="mt-6 border-t pt-4 border-red-200">
                        <h4 class="text-xl font-bold text-red-700 mb-2">‚ùå Jarima Ballari</h4>
                        <div class="flex justify-between items-center bg-red-50 p-3 rounded-md shadow-md">
                            <p class="font-semibold text-red-600">Qirqilgan Ball:</p>
                            <p class="text-xl font-bold text-red-600">-${teacherData.penaltyAmount} ball</p>
                        </div>
                        ${teacherData.penaltyReason ? `
                            <p class="mt-2 text-sm text-gray-700 font-medium italic">Sababi: ${teacherData.penaltyReason}</p>
                        ` : ''}
                    </div>
                `;
            }

            // Kontentni div ichiga joylash
            detailDiv.innerHTML = scoresListHTML + penaltyHTML;
        }

        async function renderTeachers() {
            const listContainer = document.getElementById('teachers-list');
            const loader = document.getElementById('loader');
            listContainer.innerHTML = '';
            loader.style.display = 'block';

            try {
                const snapshot = await teachersRef.get();
                const teachers = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    let totalScore = 0;
                    
                    if (data.scores) {
                        totalScore = Object.values(data.scores).reduce((sum, score) => sum + score, 0);
                    }
                    
                    const penaltyAmount = data.penalty ? data.penalty.amount : 0; 
                    const penaltyReason = data.penalty ? data.penalty.reason : '';
                    const finalScore = totalScore - penaltyAmount; 
                    
                    const normalizedScore = Math.min(MAX_SCORE, Math.max(0, finalScore));

                    const { status: currentStatus, chartColor, percentage: totalScorePercentage, statusColorClass } = getScoreStatus(normalizedScore);

                    teachers.push({ 
                        id: doc.id, 
                        totalScore: normalizedScore, 
                        totalScorePercentage: totalScorePercentage,
                        penaltyAmount: penaltyAmount, 
                        penaltyReason: penaltyReason,
                        currentStatus: currentStatus,
                        chartColor: chartColor,
                        statusColorClass: statusColorClass,
                        scoreCriteria: data.scoreCriteria || {} , // Kriteriyani qo'shamiz
                        scores: data.scores || {}
                    });
                });

                teachers.sort((a, b) => b.totalScorePercentage - a.totalScorePercentage); 

                teachers.forEach((teacher, index) => {
                    // teacher o'zgaruvchisidan DOM elementini topish uchun yordamchi id beramiz
                    const cardId = `teacher-card-${teacher.id}`;
                    
                    const cardHTML = `
                        <div id="${cardId}" class="teacher-card rounded-xl border-t-4 ${teacher.statusColorClass.replace('bg-', 'border-')} border-opacity-70 shadow-lg bg-white" 
                             onclick="toggleDetails(this, ${JSON.stringify(teacher).replace(/"/g, '&quot;').replace(/'/g, '&#39;')})"> 
                            <div class="p-5">
                                
                                <div class="flex justify-between items-start mb-3">
                                    <span class="inline-block px-3 py-1 text-xs font-bold rounded-full ${teacher.statusColorClass} text-white shadow-md">${teacher.currentStatus}</span>
                                    <span class="text-xl font-extrabold text-indigo-400">${index + 1}.</span>
                                </div>

                                <h3 class="text-xl font-bold text-gray-900 mb-2">${teacher.name}</h3>
                                
                                <p class="text-lg font-medium text-gray-600 mb-1">To'plangan Foiz:</p>
                                <p class="text-4xl font-black mb-4" style="color: ${teacher.chartColor};">
                                    ${teacher.totalScorePercentage.toFixed(1)}% 
                                </p>
                                
                                <div class="w-full h-2 bg-gray-200 rounded-full mb-2">
                                    <div class="h-full rounded-full transition-all duration-700 shadow-md" style="width: ${teacher.totalScorePercentage}%; background-color: ${teacher.chartColor};"></div>
                                </div>
                                
                                ${teacher.penaltyAmount > 0 ? `
                                    <div class="text-sm font-medium text-red-600 mt-3 p-1 bg-red-100 rounded text-center border border-red-300">
                                        ‚ùå Jarima Balli: -${teacher.penaltyAmount} ball
                                    </div>
                                ` : ''}

                                <p class="text-xs text-gray-500 mt-2 text-center font-medium hover:text-indigo-600 cursor-pointer">Batafsil ma'lumotni ko'rish/yopish uchun bosing</p>
                                
                                <div class="details-content mt-4">
                                    </div>
                                
                            </div>
                        </div>
                    `;
                    listContainer.insertAdjacentHTML('beforeend', cardHTML);
                });

            } catch (error) {
                console.error("Ma'lumotlarni yuklashda xatolik:", error);
                listContainer.innerHTML = '<p class="text-red-500 text-center text-xl py-10">Ma\'lumotlarni yuklashda xatolik yuz berdi.</p>';
            } finally {
                loader.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', renderTeachers);
    </script>
</body>
</html>