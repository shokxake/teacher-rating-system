<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texnikum O'qituvchilar Reytingi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        /* CSS: Ball Tafsilotlari qismini animatsiya bilan yashirish/ko'rsatish */
        .details-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            padding-top: 0;
            opacity: 0;
        }
        .details-container.active {
            max-height: 500px;
            transition: max-height 0.6s ease-in, opacity 0.6s ease-in;
            opacity: 1;
            padding-top: 0.75rem; /* pt-3 ga teng */
        }

        /* CARD STYLE: Yumshoqroq soya va fon rangini yaxshilash */
        .teacher-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
            background-color: #ffffff; /* Oq fon */
        }
        .teacher-card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.08);
            transform: translateY(-3px);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-white shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-indigo-800 tracking-wider">üåü O'qituvchilar Reytingi</h1>
            <nav class="flex space-x-4 items-center">
                <a href="charts.html" class="text-sm font-semibold text-purple-700 hover:text-purple-900 px-4 py-2 rounded-full transition duration-200 bg-purple-100 hover:bg-purple-200 shadow-sm">üìä Global Diagramma</a>
                <a href="admin.html" class="text-sm font-semibold text-gray-600 hover:text-gray-800 px-4 py-2 rounded-full transition duration-200 border border-gray-300">Admin Panel</a>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-8 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            
            <h2 class="text-3xl font-extrabold text-gray-900 mb-10 text-center">‚≠ê Umumiy Reyting Jadvallari (100 ball)</h2>

            <div id="loader" class="text-center py-20">
                <p class="text-2xl font-medium text-indigo-500 animate-pulse">Ma'lumotlar yuklanmoqda...</p>
            </div>

            <div id="teachers-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
                </div>
        </div>
    </main>

    <script>
        // *** FIREBASE KONFIGURATSIYASI (Siz kiritgan ma'lumotlar) ***
        const firebaseConfig = {
            apiKey: "AIzaSyBoeZhwbVlnO7ua92G1MEbkgvR56wafczo", 
            authDomain: "myrating-db64e.firebaseapp.com",
            projectId: "myrating-db64e",
            storageBucket: "myrating-db64e.appspot.com",
            messagingSenderId: "544027915154",
            appId: "1:544027915154:web:9ea438a621ea6f0832074b"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const teachersRef = db.collection('teachers');

        // Balga qarab rangni aniqlash
        function getScoreStatus(score) {
            if (score < 55) {
                return { color: 'bg-red-500', label: 'Qoniqarsiz', statusColor: 'border-red-600', chartColor: '#ef4444' }; // Qizil
            } else if (score >= 85) {
                return { color: 'bg-green-500', label: "A'lo", statusColor: 'border-green-600', chartColor: '#10b981' }; // Yashil
            } else {
                return { color: 'bg-yellow-500', label: 'Yaxshi', statusColor: 'border-yellow-600', chartColor: '#f59e0b' }; // Sariq
            }
        }

        // Ball Tafsilotlarini ko'rsatish/yashirish funksiyasi
        window.toggleDetails = function(teacherId) {
            const details = document.getElementById(`details-${teacherId}`);
            const button = document.getElementById(`btn-toggle-${teacherId}`);
            
            details.classList.toggle('active');

            if (details.classList.contains('active')) {
                button.textContent = "üëÜ Tafsilotlarni yashirish";
            } else {
                button.textContent = "üëá Tafsilotlarni ko'rsatish";
            }
        };


        async function renderTeachers() {
            const listContainer = document.getElementById('teachers-list');
            const loader = document.getElementById('loader');
            listContainer.innerHTML = '';
            loader.style.display = 'block';

            try {
                const snapshot = await teachersRef.get();
                const teachers = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    let totalScore = 0;
                    
                    if (data.scores) {
                        totalScore = Object.values(data.scores).reduce((sum, score) => sum + score, 0);
                    }
                    totalScore = Math.min(100, Math.max(0, totalScore));

                    teachers.push({ id: doc.id, totalScore, ...data });
                });

                teachers.sort((a, b) => b.totalScore - a.totalScore);

                teachers.forEach((teacher, index) => {
                    const scoreData = teacher.scores || {};
                    const { color, label, statusColor, chartColor } = getScoreStatus(teacher.totalScore);
                    const criteria = teacher.scoreCriteria || {};
                    
                    const scoresList = Object.keys(criteria).map(key => {
                        const maxScore = criteria[key];
                        const currentScore = scoreData[key] || 0;
                        return `<li class="flex justify-between items-center text-sm text-gray-600 py-1">
                                    <span>${key}:</span>
                                    <span class="font-semibold text-gray-800">${currentScore} / ${maxScore} ball</span>
                                </li>`;
                    }).join('');

                    // Dizayn o'zgarishlari shu yerda
                    const cardHTML = `
                        <div class="teacher-card rounded-xl overflow-hidden border-t-4 border-r-2 ${statusColor} border-opacity-70">
                            <div class="p-5">
                                <div class="flex justify-between items-center mb-3">
                                    <span class="inline-block px-3 py-1 text-xs font-bold rounded-full ${color} text-white shadow-md">${label}</span>
                                    <span class="text-xl font-extrabold text-indigo-400">${index + 1}.</span>
                                </div>

                                <h3 class="text-xl font-bold text-gray-900 mb-2">${teacher.name}</h3>
                                
                                <p class="text-lg font-medium text-gray-600 mb-1">Jami Ball:</p>
                                <p class="text-4xl font-black text-indigo-700 mb-4">${teacher.totalScore} <span class="text-xl font-normal text-gray-500">/ 100</span></p>
                                
                                <div class="w-full h-2 bg-gray-200 rounded-full mb-5">
                                    <div class="h-full rounded-full transition-all duration-700 shadow-md" style="width: ${teacher.totalScore}%; background-color: ${chartColor};"></div>
                                </div>
                                
                                <button id="btn-toggle-${teacher.id}" onclick="toggleDetails('${teacher.id}')" 
                                    class="w-full text-sm font-semibold text-indigo-600 hover:text-indigo-800 py-1.5 rounded-lg transition duration-150 border border-indigo-200 hover:bg-indigo-50">
                                    üëá Tafsilotlarni ko'rsatish
                                </button>
                                
                                <div id="details-${teacher.id}" class="details-container">
                                    <div class="pt-3 border-t border-gray-200 mt-2">
                                        <h4 class="text-sm font-bold text-gray-700 mb-2">Ball Tafsilotlari:</h4>
                                        <ul class="list-none space-y-1">
                                            ${scoresList || '<li class="text-sm text-gray-500">Kriteriyalar mavjud emas.</li>'}
                                        </ul>
                                    </div>
                                </div>

                            </div>
                        </div>
                    `;
                    listContainer.insertAdjacentHTML('beforeend', cardHTML);
                });

            } catch (error) {
                console.error("Ma'lumotlarni yuklashda xatolik:", error);
                listContainer.innerHTML = '<p class="text-red-500 text-center text-xl py-10">Ma\'lumotlarni yuklashda xatolik yuz berdi.</p>';
            } finally {
                loader.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', renderTeachers);
    </script>
</body>
</html>