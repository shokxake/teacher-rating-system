<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Reyting Diagrammasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-purple-700">üìä Global Reyting Diagrammasi (Maks. 798 ball)</h1>
            <a href="index.html" class="text-sm font-medium text-indigo-600 hover:text-indigo-800 px-3 py-1 rounded-md transition duration-150 border border-indigo-300">üè° Asosiy Sahifa</a>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-8 sm:px-6 lg:px-8">
        <div class="bg-white p-8 shadow-xl rounded-lg">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">O'qituvchilarning Umumiy Ballari (798 balldan)</h2>

            <div id="loader-chart" class="text-center py-20">
                <p class="text-xl font-medium text-purple-500">Diagramma ma'lumotlari yuklanmoqda...</p>
            </div>
            
            <div class="w-full relative" id="chart-container" style="display: none;">
                <canvas id="teachersChart"></canvas>
            </div>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBoeZhwbVlnO7ua92G1MEbkgvR56wafczo", 
            authDomain: "myrating-db64e.firebaseapp.com",
            projectId: "myrating-db64e",
            storageBucket: "myrating-db64e.appspot.com",
            messagingSenderId: "544027915154",
            appId: "1:544027915154:web:9ea438a621ea6f0832074b"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const teachersRef = db.collection('teachers');

        const MAX_SCORE = 798;
        
        // Ranglarni foiz asosida aniqlash (56-85% oraliq)
        function getScoreStatus(totalScore) {
            const percentage = (totalScore / MAX_SCORE) * 100;
            let chartColor;

            if (percentage >= 86) {
                chartColor = '#10b981'; // Yashil (A'lo)
            } else if (percentage >= 56) {
                chartColor = '#f59e0b'; // Sariq (Yaxshi)
            } else {
                chartColor = '#ef4444'; // Qizil (Qoniqarsiz)
            }
            return { chartColor };
        }

        async function drawGlobalChart() {
            const loader = document.getElementById('loader-chart');
            const chartContainer = document.getElementById('chart-container');
            
            try {
                const snapshot = await teachersRef.get();
                const teachers = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    let totalScore = 0;
                    
                    if (data.scores) {
                        totalScore = Object.values(data.scores).reduce((sum, score) => sum + score, 0);
                    }

                    // Jarima ballarini ayirish
                    const penaltyAmount = data.penalty ? data.penalty.amount : 0; 
                    const finalScore = totalScore - penaltyAmount;
                    
                    const normalizedScore = Math.min(MAX_SCORE, Math.max(0, finalScore));
                    
                    teachers.push({ totalScore: normalizedScore, name: data.name });
                });

                teachers.sort((a, b) => b.totalScore - a.totalScore);
                
                const labels = teachers.map(t => t.name);
                const scores = teachers.map(t => t.totalScore);
                const colors = teachers.map(t => getScoreStatus(t.totalScore).chartColor);

                // Kontent ko'p bo'lsa, Canvas balandligini dinamik sozlash
                const dynamicHeight = Math.max(500, teachers.length * 35 + 100); 
                chartContainer.style.height = `${dynamicHeight}px`;

                loader.style.display = 'none';
                chartContainer.style.display = 'block';

                new Chart(document.getElementById('teachersChart'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Jami Ball (${MAX_SCORE} dan)`,
                            data: scores, 
                            backgroundColor: colors, 
                            borderWidth: 1.5,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: { // Bu endi Ballarni ko'rsatadi
                                beginAtZero: true,
                                max: 800, // Maksimal ball 798 ga moslab 800 qo'yildi
                                title: { display: true, text: 'Olingan Ball (798 gacha)' },
                                ticks: {
                                    stepSize: 100 
                                }
                            },
                            y: { 
                                title: { display: true, text: 'O\'qituvchilar Nomi' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const score = context.formattedValue;
                                        const percentage = ((score / MAX_SCORE) * 100).toFixed(1);
                                        return `Jami Ball: ${score} / ${MAX_SCORE} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error("Global diagrammani yuklashda xatolik:", error);
                loader.innerHTML = '<p class="text-red-500 text-center text-xl py-10">Diagramma ma\'lumotlarini yuklashda xatolik.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', drawGlobalChart);
    </script>
</body>
</html>